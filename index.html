<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒå‹åº«å­˜ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background-color: #f8f9fa; padding-bottom: 60px; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-link { color: #6c757d; font-size: 0.8rem; }
        .nav-link.active { color: #0d6efd; }
        .scan-box { width: 100%; height: 300px; background: #000; display: none; }
        .low-stock { background-color: #ffebee; }
    </style>
</head>
<body>

<div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5>ğŸ” å®‰å…¨ç™»éŒ„</h5></div>
            <div class="modal-body">
                <input type="password" id="passwordInput" class="form-control" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ (é è¨­: 123456)">
                <div id="loginError" class="text-danger mt-2" style="display:none;">å¯†ç¢¼éŒ¯èª¤</div>
            </div>
            <div class="modal-footer"><button onclick="checkLogin()" class="btn btn-primary w-100">ç™»å…¥</button></div>
        </div>
    </div>
</div>

<div class="container py-3" id="mainApp" style="display:none;">
    <h4 class="text-center mb-4 fw-bold text-primary">åƒå‹åº«å­˜ç³»çµ±</h4>

    <div id="section-in" class="content-section">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-box-arrow-in-down"></i> å…¥åº«ä½œæ¥­</h5>
                <button class="btn btn-outline-primary w-100 mb-3" onclick="startScanner('in')">ğŸ“¸ æƒç¢¼è­˜åˆ¥</button>
                <div id="reader-in" class="scan-box mb-3"></div>
                
                <form id="inForm" onsubmit="event.preventDefault(); addStock();">
                    <div class="mb-2">
                        <label>ç”¢å“ç…§ç‰‡</label>
                        <input type="file" id="prodImg" class="form-control" accept="image/*" onchange="previewImage(this)">
                        <img id="imgPreview" class="img-thumbnail mt-2" style="max-height:100px; display:none;">
                    </div>
                    <input type="text" id="inName" class="form-control mb-2" placeholder="å“å" required>
                    <input type="text" id="inCompany" class="form-control mb-2" placeholder="å…¬å¸åç¨±">
                    <input type="number" id="inQty" class="form-control mb-2" placeholder="æ•¸é‡" required>
                    <input type="text" id="inCode" class="form-control mb-3" placeholder="æµæ°´è™Ÿ (è‡ªå‹•ç”Ÿæˆ)" readonly>
                    <button type="submit" class="btn btn-primary w-100">ç¢ºèªå…¥åº«ä¸¦ç”Ÿæˆæ¨™ç±¤</button>
                </form>
                <div id="qrcodeArea" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>

    <div id="section-out" class="content-section" style="display:none;">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-box-arrow-up"></i> å‡ºåº«ä½œæ¥­</h5>
                <button class="btn btn-outline-danger w-100 mb-3" onclick="startScanner('out')">ğŸ“¸ æƒç¢¼å‡ºåº«</button>
                <div id="reader-out" class="scan-box mb-3"></div>
                <input type="text" id="searchOut" class="form-control mb-3" placeholder="ğŸ” æœå°‹å“å/ç·¨è™Ÿ/å…¬å¸..." onkeyup="renderOutList()">
                <div id="outList" class="list-group"></div>
            </div>
        </div>
    </div>

    <div id="section-db" class="content-section" style="display:none;">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-database"></i> åº«å­˜ç¸½è¡¨</h5>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-success flex-grow-1" onclick="exportCSV()">ğŸ“¤ åŒ¯å‡ºå ±è¡¨</button>
                    <button class="btn btn-info flex-grow-1 text-white" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ¸…å–®</button>
                </div>
                <input type="text" id="dbSearch" class="form-control mb-2" placeholder="å¤šæ¢ä»¶æœå°‹..." onkeyup="renderDbTable()">
                <select id="dbCompanyFilter" class="form-select mb-3" onchange="renderDbTable()">
                    <option value="">å…¨éƒ¨å…¬å¸</option>
                </select>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm" id="dbTable">
                        <thead class="table-light"><tr><th>åœ–</th><th>å“å</th><th>å…¬å¸</th><th>åº«å­˜</th><th>ç‹€æ…‹</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <canvas id="stockChart" class="mt-4"></canvas>
            </div>
        </div>
    </div>
</div>

<nav class="nav-bottom py-2">
    <div class="row text-center m-0">
        <div class="col" onclick="showSection('in')"><i class="bi bi-box-arrow-in-down fs-4"></i><div class="small">å…¥åº«</div></div>
        <div class="col" onclick="showSection('out')"><i class="bi bi-box-arrow-up fs-4"></i><div class="small">å‡ºåº«</div></div>
        <div class="col" onclick="showSection('db')"><i class="bi bi-database fs-4"></i><div class="small">è³‡æ–™åº«</div></div>
    </div>
</nav>

<script>
    let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
    let html5QrCode;

    // åˆå§‹åŒ–
    window.onload = function() {
        new bootstrap.Modal(document.getElementById('loginModal')).show();
        generateCode();
    };

    function checkLogin() {
        if(document.getElementById('passwordInput').value === '123456') {
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            document.getElementById('mainApp').style.display = 'block';
            renderOutList();
            renderDbTable();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function showSection(id) {
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
        document.getElementById('section-' + id).style.display = 'block';
        if(id === 'db') renderDbTable();
        if(id === 'out') renderOutList();
        if(html5QrCode) html5QrCode.stop();
    }

    function generateCode() {
        document.getElementById('inCode').value = 'PROD-' + Date.now().toString().slice(-6);
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imgPreview').src = e.target.result;
                document.getElementById('imgPreview').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addStock() {
        const item = {
            id: document.getElementById('inCode').value,
            name: document.getElementById('inName').value,
            company: document.getElementById('inCompany').value,
            qty: parseInt(document.getElementById('inQty').value),
            img: document.getElementById('imgPreview').src || '',
            date: new Date().toISOString().split('T')[0]
        };
        
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existing = inventory.find(x => x.id === item.id);
        if(existing) existing.qty += item.qty;
        else inventory.push(item);
        
        saveData();
        alert('å…¥åº«æˆåŠŸï¼');
        
        // ç”Ÿæˆ QR Code
        const qrDiv = document.getElementById('qrcodeArea');
        qrDiv.innerHTML = '';
        new QRCode(qrDiv, { text: item.id, width: 128, height: 128 });
        
        // é‡ç½®è¡¨å–®
        document.getElementById('inForm').reset();
        document.getElementById('imgPreview').style.display = 'none';
        generateCode();
    }

    function renderOutList() {
        const term = document.getElementById('searchOut').value.toLowerCase();
        const list = document.getElementById('outList');
        list.innerHTML = '';
        
        inventory.filter(i => 
            i.name.toLowerCase().includes(term) || 
            i.id.toLowerCase().includes(term) ||
            i.company.toLowerCase().includes(term)
        ).forEach(item => {
            const div = document.createElement('div');
            div.className = `list-group-item d-flex justify-content-between align-items-center ${item.qty < 5 ? 'low-stock' : ''}`;
            div.innerHTML = `
                <div class="d-flex align-items-center">
                    ${item.img ? `<img src="${item.img}" style="width:40px;height:40px;object-fit:cover;margin-right:10px;">` : ''}
                    <div>
                        <div class="fw-bold">${item.name}</div>
                        <small class="text-muted">${item.company} | åº«å­˜: ${item.qty}</small>
                        ${item.qty < 5 ? '<span class="badge bg-danger">ä½åº«å­˜</span>' : ''}
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="updateStock('${item.id}', -1)">-1</button>
            `;
            list.appendChild(div);
        });
    }

    function renderDbTable() {
        const term = document.getElementById('dbSearch').value.toLowerCase();
        const companyFilter = document.getElementById('dbCompanyFilter').value;
        const tbody = document.querySelector('#dbTable tbody');
        tbody.innerHTML = '';
        
        // æ›´æ–°å…¬å¸ç¯©é¸é¸å–®
        const companies = [...new Set(inventory.map(i => i.company))];
        const select = document.getElementById('dbCompanyFilter');
        if(select.options.length === 1) {
            companies.forEach(c => select.add(new Option(c, c)));
        }

        const filtered = inventory.filter(i => 
            (i.name.toLowerCase().includes(term) || i.id.toLowerCase().includes(term)) &&
            (companyFilter === '' || i.company === companyFilter)
        );

        filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.img ? `<img src="${item.img}" style="width:30px">` : ''}</td>
                <td contenteditable onblur="updateField('${item.id}', 'name', this.innerText)">${item.name}</td>
                <td contenteditable onblur="updateField('${item.id}', 'company', this.innerText)">${item.company}</td>
                <td>${item.qty}</td>
                <td>${item.qty < 5 ? 'âš ï¸' : 'âœ…'}</td>
            `;
            tbody.appendChild(tr);
        });

        updateChart(filtered);
    }

    function updateStock(id, change) {
        const item = inventory.find(i => i.id === id);
        if(item) {
            item.qty += change;
            if(item.qty < 0) item.qty = 0;
            saveData();
            renderOutList();
            renderDbTable();
        }
    }

    function updateField(id, field, value) {
        const item = inventory.find(i => i.id === id);
        if(item) {
            item[field] = value;
            saveData();
        }
    }

    function saveData() {
        localStorage.setItem('inventory', JSON.stringify(inventory));
    }

    function startScanner(mode) {
        const readerId = mode === 'in' ? 'reader-in' : 'reader-out';
        document.getElementById(readerId).style.display = 'block';
        html5QrCode = new Html5Qrcode(readerId);
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
                if(mode === 'in') {
                    // å…¥åº«æ¨¡å¼é‚è¼¯...
                    alert('æƒæåˆ°: ' + decodedText);
                } else {
                    document.getElementById('searchOut').value = decodedText;
                    renderOutList();
                }
                html5QrCode.stop();
                document.getElementById(readerId).style.display = 'none';
            },
            (errorMessage) => {}
        );
    }

    function updateChart(data) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(i => i.name),
                datasets: [{
                    label: 'åº«å­˜æ•¸é‡',
                    data: data.map(i => i.qty),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)'
                }]
            }
        });
    }
    
    function exportCSV() {
        let csv = "ID,å“å,å…¬å¸,æ•¸é‡,æ—¥æœŸ\n";
        inventory.forEach(i => {
            csv += `${i.id},${i.name},${i.company},${i.qty},${i.date}\n`;
        });
        const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "inventory.csv";
        link.click();
    }
</script>
</body>
</html>